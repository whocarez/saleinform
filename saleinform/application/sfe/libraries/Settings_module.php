<?phpif (!defined('BASEPATH')) exit('No direct script access allowed');/* * Settings module * Mazvv 03-05-2007*/class Settings_module{	private $ciObject;	private $objectsArr = array();	/*-----------------------------------*/	private $currentSettings = array();
	public function __construct(){		$this->ciObject = &get_instance();		$this->ciObject->lang->load('settings_module');		$currentSESS = $this->ciObject->session->userdata('_SI_');		$this->ciObject->load->model('settings_model');		if(!element('SI_SETTINGS', $currentSESS)) { 			$this->_SetSessionContext(); 			$currentSESS = $this->ciObject->session->userdata('_SI_');		}		$this->currentSettings = element('SI_SETTINGS', $currentSESS);	}
	public function renderSettingsArea(){		$data['settings'] = $this->currentSettings;		$data['officialcources'] = $this->ciObject->settings_model->GetOfficialCources($data['settings']['_COUNTRY_RID_']);		return $this->ciObject->load->view('modules/settings_module/settingsarea.php',$data, True);	}
	public function RenderSetSettingsArea(){		$data = array();		$data['saveOk']=False;		if($this->ciObject->input->post('go_settings')){			$this->_SetSessionContext((int)$this->ciObject->input->post('_countries_rid'), (int)$this->ciObject->input->post('_currency_rid'), (int)$this->ciObject->input->post('_regions_rid'), (int)$this->ciObject->input->post('_cities_rid'));			$this->currentSettings = element('SI_SETTINGS', $this->ciObject->session->userdata('_SI_'));			$data['saveOk']=True;		}		$data['settings'] = $this->currentSettings;		$data['countries_list'] = $this->ciObject->settings_model->GetCountriesList();				$data['currencies_list'] = $this->ciObject->settings_model->GetCurrenciesList();		$data['regions_list'] = ($regionsLIST = $this->ciObject->settings_model->GetRegionsList(element('_COUNTRY_RID_', $data['settings'])))?$regionsLIST:array();		$data['cities_list'] = ($data['regions_list'])?$this->ciObject->settings_model->GetCitiesList(element('_REGION_RID_', $data['settings'])):array();		return $this->ciObject->load->view('modules/settings_module/setsettingsarea.php',$data, True);	}
	
	public function changeCountry(){		/* if change country update currency, regions and cities */		if($_countries_rid = $this->ciObject->input->post('_countries_rid')){			$data['settings'] = $this->currentSettings;			$data['currencies_list'] = $this->ciObject->settings_model->GetCurrenciesList();			/* корректировка основной валюты */			$countryInfo = $this->ciObject->settings_model->getCountryInfo($_countries_rid);			$data['settings']['_MAIN_CURR_RID_'] =  $countryInfo->_currency_rid;			$data['settings']['_MAIN_CURR_NAME_'] =  $countryInfo->curr_name;			$data['regions_list'] = ($regionsLIST = $this->ciObject->settings_model->GetRegionsList($_countries_rid))?$regionsLIST:array();			$data['cities_list'] = array();			return $this->ciObject->load->view('modules/settings_module/objects_container.php', $data, True);		}	}
	public function changeRegion(){		/* if change country update currency, regions and cities */		if($_regions_rid = $this->ciObject->input->post('_regions_rid')){			$data['settings'] = $this->currentSettings;			$data['cities_list'] = ($_regions_rid)?$this->ciObject->settings_model->GetCitiesList($_regions_rid):array();			return $this->ciObject->load->view('modules/settings_module/_cities_list.php', $data, True);		}	}
	public function _SetSessionContext($countryRid=null, $currencyRid=null, $regionsRid=null, $cityRid=null){		#$this->ciObject->load->plugin('geoip');		/*установка значений по умолчанию*/		#TODO: сделать эти настройки в базе		if(!$countryRid){			#$countryCod = GetCountryCod($_SERVER['REMOTE_ADDR']);			$countryRid = '5';			$regionsRid = null;			$cityRid = null;			$currencyRid = '7';		} 		$st = $this->ciObject->settings_model->GetSettings($countryRid, $currencyRid, $regionsRid, $cityRid);		$currentSESS = $this->ciObject->session->userdata('_SI_');		$currentSESS['SI_SETTINGS']['_COUNTRY_RID_'] = (isset($st['countryRID']))?$st['countryRID']:null;		$currentSESS['SI_SETTINGS']['_COUNTRY_NAME_'] = (isset($st['countryNAME']))?$st['countryNAME']:null;		$currentSESS['SI_SETTINGS']['_REGION_RID_'] = (isset($st['regionRID']))?$st['regionRID']:null;		$currentSESS['SI_SETTINGS']['_REGION_NAME_'] = (isset($st['regionNAME']))?$st['regionNAME']:lang('SETTINGS_ALL');		$currentSESS['SI_SETTINGS']['_CITY_RID_'] = (isset($st['cityRID']))?$st['cityRID']:null;		$currentSESS['SI_SETTINGS']['_CITY_NAME_'] = (isset($st['cityNAME']))?$st['cityNAME']:lang('SETTINGS_ALL');		$currentSESS['SI_SETTINGS']['_MAIN_CURR_RID_'] = (isset($st['currencyRID']))?$st['currencyRID']:null;		$currentSESS['SI_SETTINGS']['_MAIN_CURR_COD_'] = (isset($st['currencyCOD']))?$st['currencyCOD']:null;		$currentSESS['SI_SETTINGS']['_MAIN_CURR_NAME_'] = (isset($st['currencyNAME']))?$st['currencyNAME']:null;		$currentSESS['SI_SETTINGS']['_MAIN_CURR_ENDWORD_'] = (isset($st['currencyENDWORD']))?$st['currencyENDWORD']:null;		$currentSESS['SI_SETTINGS']['_ADD_CURR_RID_'] = (isset($st['addcurrencyRID']))?$st['addcurrencyRID']:null;		$currentSESS['SI_SETTINGS']['_ADD_CURR_COD_'] = (isset($st['addcurrencyCOD']))?$st['addcurrencyCOD']:null;		$currentSESS['SI_SETTINGS']['_ADD_CURR_NAME_'] = (isset($st['addcurrencyNAME']))?$st['addcurrencyNAME']:null;		$currentSESS['SI_SETTINGS']['_ADD_CURR_ENDWORD_'] = (isset($st['addcurrencyENDWORD']))?$st['addcurrencyENDWORD']:null;		$this->ciObject->session->set_userdata('_SI_', $currentSESS);		return;	}
	public function getSetting($settingName){		return element($settingName, $this->currentSettings);	}
}
?>