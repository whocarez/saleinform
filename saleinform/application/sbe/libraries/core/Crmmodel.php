<?php/** * TravelCRM * * An open source CRM system for travel agencies * * @package		Core * @author		mazvv * @license		GNU GPLv3 (http://gplv3.fsf.org)  * @link		http://code.google.com/p/travelcrm/ *//** * Abstract model class, base for all models *  * @author mazvv * @package Libraries * @subpackage Core */abstract class Crmmodel extends Model{	protected $ci; # global Codeigniter object		public function __construct() {		parent::Model();		# get global Codeigniter object		$this->ci = &get_instance();	}
		/**	 * Get Rows Quan	 * 	 * Get total rows in recordset	 * 	 * @access public	 * @return int	 */	public function get_calc_rows(){		return $this->db->select('FOUND_ROWS() as rquan')->get()->row()->rquan;	}		/**	 * Get secured recordset 	 * 	 * Get available records useng security subsystem	 *  	 * @param $p_fromTable query object	 * @return query object 	 */	public function db_get($p_fromTable){		if($area = $this->ci->menu->get_item_area()){			switch ($area){				case 'FILIAL':{					/*					 * When for filials only					 * */					$this->db->join('_users', "{$p_fromTable}.owner_users_rid = _users.rid and _users.archive = 0");					$this->db->join('_employeers', "_users._employeers_rid = _employeers.rid and _employeers.archive = 0");					#$this->db->join('_filials', "_employeers._filials_rid = _filials.rid and _filials.archive = 0");					$this->db->join('_filials', '_filials.rid = (select _emp_to_positions_rows._filials_rid 									from _emp_to_positions_rows join _filials on _emp_to_positions_rows._filials_rid = _filials.rid 									where _emp_to_positions_rows._employeers_rid = _employeers.rid and _emp_to_positions_rows.bdate<=\''.date('Y-m-d').'\' order by _emp_to_positions_rows.bdate DESC limit 1)');					$this->db->where(array('_filials.rid'=>$this->ciObject->user->GetFilialRid()));					break;				}				case 'OWN':{					/*					 * When for own only					 * */					$this->db->join('_users', "{$p_fromTable}.owner_users_rid = _users.rid and _users.archive = 0");					$this->db->where(array('_users.rid'=>$this->ciObject->user->GetUserRid()));					break;				}				default: {break;}			}		}		return $this->db->get();	}}
?>